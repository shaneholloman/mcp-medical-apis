---
test_name: Every Cure Matrix Knowledge Graph - Complete Test Suite

marks:
  - tavern
  - usefixtures:
      - server_process

stages:
  # ============================================================================
  # SECTION 1: Basic Tools (Schema, Stats, Cypher)
  # ============================================================================
  
  - name: Get database schema
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 1
        method: "tools/call"
        params:
          name: "everycure_kg_get_schema"
          arguments: {}
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      verify_response_with:
        - function: tests.tavern_utils:validate_saved_json
          extra_kwargs:
            variable_name: "parsed_json"
            expected_body:
              api_source: "Every Cure Matrix Knowledge Graph"
              data:
                labels:
                  type: list
                  min_length: 1
                relationship_types:
                  type: list
                  min_length: 1
                property_keys:
                  type: list
              metadata:
                type: dict
                required:
                  - database
      json:
        jsonrpc: "2.0"
        id: 1
        result:
          content:
            - type: "text"
          isError: false

  - name: Get database statistics
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 2
        method: "tools/call"
        params:
          name: "everycure_kg_get_stats"
          arguments: {}
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 2

  - name: Query specific node by ID (GO:0036480)
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 3
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: 'MATCH (n {{id: $node_id}}) RETURN n.id as node_id_field, n.name as name, labels(n) as labels LIMIT 1'
            parameters:
              node_id: "GO:0036480"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 3

  - name: Get 1-hop neighborhood of GO:0036480
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 4
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: |
              MATCH (n {{id: $node_id}})-[r]-(m)
              RETURN type(r) as relationship_type,
                     labels(m) as target_labels,
                     m.id as target_id,
                     m.name as target_name
              LIMIT 10
            parameters:
              node_id: "GO:0036480"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 4

  - name: Count relationships for a node
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 5
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: |
              MATCH (n {{id: $node_id}})-[r]-(m)
              RETURN count(DISTINCT m) as neighbor_count, count(r) as relationship_count
            parameters:
              node_id: "GO:0036480"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 5

  - name: Find pathways related to GO:0036480 via regulates relationship
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 6
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: |
              MATCH (n {{id: $node_id}})-[r:regulates]-(m)
              WHERE 'biolink:Pathway' IN labels(m) OR 'biolink:BiologicalProcess' IN labels(m)
              RETURN m.id as pathway_id, m.name as pathway_name, type(r) as rel_type
              LIMIT 5
            parameters:
              node_id: "GO:0036480"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 6

  - name: Query with specific database version
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 7
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: 'MATCH (n {{id: $node_id}}) RETURN n.id as node_id_field LIMIT 1'
            parameters:
              node_id: "GO:0036480"
            database: "everycure-v0.13.0"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 7

  - name: Execute invalid Cypher query
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 8
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: "INVALID CYPHER QUERY SYNTAX"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      verify_response_with:
        - function: tests.tavern_utils:validate_saved_json
          extra_kwargs:
            variable_name: "parsed_json"
            expected_body:
              api_source: "Every Cure Matrix Knowledge Graph"
              data: null
              metadata:
                error:
                  type: str
                  contains: "Error"
                database:
                  type: str
      json:
        id: 8

  # ============================================================================
  # SECTION 2: Path Finding (Metapaths)
  # ============================================================================

  - name: Get supported metapaths
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 9
        method: "tools/call"
        params:
          name: "everycure_kg_get_supported_metapaths"
          arguments: {}
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 9

  - name: Find paths using drug_to_disease_direct metapath
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 10
        method: "tools/call"
        params:
          name: "everycure_kg_find_paths_by_metapath"
          arguments:
            source_id: "UMLS:C0017302"
            target_id: "MONDO:0007113"
            metapath_name: "drug_to_disease_direct"
            max_paths: 5
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      verify_response_with:
        - function: tests.tavern_utils:validate_saved_json
          extra_kwargs:
            variable_name: "parsed_json"
            expected_body:
              api_source: "Every Cure Matrix Knowledge Graph"
              data:
                paths:
                  type: list
                  min_length: 0
              metadata:
                type: dict
                required:
                  - database
                  - source_id
                  - target_id
                  - path_count
                  - max_paths
      json:
        id: 10

  - name: Test invalid metapath name
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 11
        method: "tools/call"
        params:
          name: "everycure_kg_find_paths_by_metapath"
          arguments:
            source_id: "UMLS:C0017302"
            target_id: "MONDO:0007113"
            metapath_name: "invalid_metapath_name"
            max_paths: 5
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      verify_response_with:
        - function: tests.tavern_utils:validate_saved_json
          extra_kwargs:
            variable_name: "parsed_json"
            expected_body:
              api_source: "Every Cure Matrix Knowledge Graph"
              data: null
              metadata:
                error:
                  type: str
                  contains: "invalid_metapath_name"
                database:
                  type: str
      json:
        id: 11

  - name: Find paths using custom metapath
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 12
        method: "tools/call"
        params:
          name: "everycure_kg_find_paths_by_custom_metapath"
          arguments:
            source_id: "UMLS:C0017302"
            target_id: "MONDO:0007113"
            metapath_pattern: "Drug->directly_physically_interacts_with->Protein->gene_product_of->Gene->associated_with->Disease"
            max_paths: 5
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      verify_response_with:
        - function: tests.tavern_utils:validate_saved_json
          extra_kwargs:
            variable_name: "parsed_json"
            expected_body:
              api_source: "Every Cure Matrix Knowledge Graph"
              data:
                paths:
                  type: list
                  min_length: 0
                metapath_pattern: "Drug->directly_physically_interacts_with->Protein->gene_product_of->Gene->associated_with->Disease"
                validated_pattern:
                  type: dict
                  required:
                    - node_labels
                    - relationship_types
                    - hops
              metadata:
                type: dict
                required:
                  - database
                  - source_id
                  - target_id
                  - path_count
                  - max_paths
      json:
        id: 12

  - name: Test custom metapath with invalid node type
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 13
        method: "tools/call"
        params:
          name: "everycure_kg_find_paths_by_custom_metapath"
          arguments:
            source_id: "UMLS:C0017302"
            target_id: "MONDO:0007113"
            metapath_pattern: "InvalidNode->treats->Disease"
            max_paths: 5
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      verify_response_with:
        - function: tests.tavern_utils:validate_saved_json
          extra_kwargs:
            variable_name: "parsed_json"
            expected_body:
              api_source: "Every Cure Matrix Knowledge Graph"
              data: null
              metadata:
                error:
                  type: str
                  contains: "Validation failed"
                validation_errors:
                  type: list
                  min_length: 1
                database:
                  type: str
      json:
        id: 13

  # ============================================================================
  # SECTION 3: Node Neighborhoods
  # ============================================================================

  - name: Get node info for MONDO:0007113
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 14
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: |
              MATCH (n {{id: $node_id}})
              RETURN n.id as node_id,
                     n.name as name,
                     labels(n) as labels,
                     keys(n) as property_keys
              LIMIT 1
            parameters:
              node_id: "MONDO:0007113"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 14

  - name: Get 1-hop neighborhood of MONDO:0007113
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 15
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: |
              MATCH (n {{id: $node_id}})-[r]-(m)
              RETURN type(r) as relationship_type,
                     labels(m) as target_labels,
                     m.id as target_id,
                     m.name as target_name
              ORDER BY relationship_type, target_id
              LIMIT 20
            parameters:
              node_id: "MONDO:0007113"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 15

  - name: Count neighbors for MONDO:0007113
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 16
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: |
              MATCH (n {{id: $node_id}})-[r]-(m)
              RETURN count(DISTINCT m) as unique_neighbors,
                     count(r) as total_relationships,
                     count(DISTINCT type(r)) as unique_relationship_types
            parameters:
              node_id: "MONDO:0007113"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 16

  - name: Get specific relationships for MONDO:0007113
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 17
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: |
              MATCH (n {{id: $node_id}})-[r:treats|treats_or_applied_or_studied_to_treat|causes|associated_with]-(m)
              RETURN type(r) as relationship_type,
                     labels(m) as target_labels,
                     m.id as target_id,
                     m.name as target_name
              ORDER BY relationship_type, target_id
              LIMIT 15
            parameters:
              node_id: "MONDO:0007113"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 17

  - name: Get node info for GO:0036480
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 18
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: |
              MATCH (n {{id: $node_id}})
              RETURN n.id as node_id,
                     n.name as name,
                     labels(n) as labels,
                     keys(n) as property_keys
              LIMIT 1
            parameters:
              node_id: "GO:0036480"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 18

  - name: Get 1-hop neighborhood of GO:0036480
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 19
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: |
              MATCH (n {{id: $node_id}})-[r]-(m)
              RETURN type(r) as relationship_type,
                     labels(m) as target_labels,
                     m.id as target_id,
                     m.name as target_name
              ORDER BY relationship_type, target_id
              LIMIT 20
            parameters:
              node_id: "GO:0036480"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 19

  - name: Count neighbors for GO:0036480
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 20
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: |
              MATCH (n {{id: $node_id}})-[r]-(m)
              RETURN count(DISTINCT m) as unique_neighbors,
                     count(r) as total_relationships,
                     count(DISTINCT type(r)) as unique_relationship_types
            parameters:
              node_id: "GO:0036480"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 20

  - name: Get regulates relationships for GO:0036480
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 21
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: |
              MATCH (n {{id: $node_id}})-[r:regulates|regulated_by]-(m)
              RETURN type(r) as relationship_type,
                     labels(m) as target_labels,
                     m.id as target_id,
                     m.name as target_name
              ORDER BY relationship_type, target_id
              LIMIT 15
            parameters:
              node_id: "GO:0036480"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 21

  - name: Compare neighborhood sizes
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 22
        method: "tools/call"
        params:
          name: "everycure_kg_execute_cypher"
          arguments:
            query: |
              MATCH (n1 {{id: $node1_id}})-[r1]-(m1),
                    (n2 {{id: $node2_id}})-[r2]-(m2)
              RETURN 
                $node1_id as node1_id,
                count(DISTINCT m1) as node1_neighbors,
                count(r1) as node1_relationships,
                $node2_id as node2_id,
                count(DISTINCT m2) as node2_neighbors,
                count(r2) as node2_relationships
            parameters:
              node1_id: "MONDO:0007113"
              node2_id: "GO:0036480"
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      json:
        id: 22

  - name: Get neighborhood for MONDO:0007113 using get_neighborhood API
    request:
      url: "http://localhost:8000/tools/everycure-kg/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 23
        method: "tools/call"
        params:
          name: "everycure_kg_get_neighborhood"
          arguments:
            node_id: "MONDO:0007113"
            max_hops: 1
            limit: 5
    response:
      status_code: 200
      strict:
        - json:off
      save:
        $ext:
          function: tests.tavern_utils:parse_and_validate_mcp_json
          extra_kwargs:
            expected_api_source: "Every Cure Matrix Knowledge Graph"
      verify_response_with:
        - function: tests.tavern_utils:validate_saved_json
          extra_kwargs:
            variable_name: "parsed_json"
            expected_body:
              api_source: "Every Cure Matrix Knowledge Graph"
              data:
                source_node:
                  type: dict
                neighbors:
                  type: list
                relationships:
                  type: list
              metadata:
                type: dict
                required:
                  - database
                  - node_id
                  - max_hops
                  - neighbor_count
                  - relationship_count
      json:
        id: 23

