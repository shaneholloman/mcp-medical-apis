---
test_name: UniProt API Tools Test Suite

marks:
  - tavern
  - usefixtures:
      - server_process

stages:
  # Test 1: get_protein - Happy Path
  - name: Get protein with valid accession (P00520)
    request:
      url: "http://localhost:8000/tools/uniprot/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 1
        method: "tools/call"
        params:
          name: "uniprot_get_protein"
          arguments:
            accession: "P00520"
            format: "json"
    response:
      status_code: 200
      strict:
        - json:off  # Allow MCP framework fields like structuredContent
      json:
        jsonrpc: "2.0"
        id: 1
        result:
          # Validate structure via structuredContent (added by FastMCP when it detects structured data)
          structuredContent:
            result:
              primaryAccession: "P00520"
              uniProtkbId: !re_search "ABL1"
          content:
            - type: "text"
              text: !re_search "P00520"
          isError: false

  # Test 2: get_protein - Error Case
  - name: Get protein with invalid accession
    request:
      url: "http://localhost:8000/tools/uniprot/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 2
        method: "tools/call"
        params:
          name: "uniprot_get_protein"
          arguments:
            accession: "INVALID_ACCESSION_12345"
    response:
      status_code: 200
      strict:
        - json:off  # Allow MCP framework fields like structuredContent
      json:
        jsonrpc: "2.0"
        id: 2
        result:
          content:
            - type: "text"
              text: !re_search "Error|not found|404"

  # Test 3: search_proteins - Happy Path
  - name: Search proteins with valid query
    request:
      url: "http://localhost:8000/tools/uniprot/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 3
        method: "tools/call"
        params:
          name: "uniprot_search_proteins"
          arguments:
            query: "gene:TP53 AND organism_id:9606"
            limit: 5
    response:
      status_code: 200
      strict:
        - json:off  # Allow MCP framework fields like structuredContent
      json:
        jsonrpc: "2.0"
        id: 3
        result:
          content:
            - type: "text"
              text: !re_search "(?s)P04637.*P53_HUMAN"
          isError: false

  # Test 4: get_protein_sequence - Happy Path
  - name: Get protein sequence with valid accession
    request:
      url: "http://localhost:8000/tools/uniprot/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 4
        method: "tools/call"
        params:
          name: "uniprot_get_protein_sequence"
          arguments:
            accession: "P00520"
    response:
      status_code: 200
      strict:
        - json:off  # Allow MCP framework fields like structuredContent
      # This returns raw text (FASTA), not JSON.
      # So we must use simple text validation.
      json:
        jsonrpc: "2.0"
        id: 4
        result:
          content:
            - type: "text"
              text: !re_search "^>sp\\|P00520\\|"

  # Test 6: get_disease_associations - Happy Path
  - name: Get disease associations with valid accession
    request:
      url: "http://localhost:8000/tools/uniprot/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 6
        method: "tools/call"
        params:
          name: "uniprot_get_disease_associations"
          arguments:
            accession: "P00520"
    response:
      status_code: 200
      strict:
        - json:off  # Allow MCP framework fields like structuredContent
      json:
        jsonrpc: "2.0"
        id: 6
        result:
          content:
            - type: "text"
              text: !re_search "(?s)diseases|P00520|count"
          isError: false

  # Test 7: map_ids - Happy Path
  - name: Map IDs with valid parameters
    request:
      url: "http://localhost:8000/tools/uniprot/mcp"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "application/json, text/event-stream"
      json:
        jsonrpc: "2.0"
        id: 7
        method: "tools/call"
        params:
          name: "uniprot_map_ids"
          arguments:
            from_db: "Gene_Name"
            to_db: "UniProtKB"
            ids: "TP53"
    response:
      status_code: 200
      strict:
        - json:off  # Allow MCP framework fields like structuredContent
      json:
        jsonrpc: "2.0"
        id: 7
        result:
          content:
            - type: "text"
              text: !re_search "(?s)TP53.*P04637|TP53|P04637"
          isError: false